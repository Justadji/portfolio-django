{% extends 'base.html' %}
{% block title %}Forum - {{ topic.titre }}{% endblock %}
{% block body_class %}theme-light{% endblock %}

{% block content %}
<section class="section">
    <div class="section-inner">
        <p>
            <a href="{% url 'forum_index' %}">Forum</a> /
            <a href="{% url 'forum_category' categorie.id %}">{{ categorie.nom }}</a>
        </p>

        <h1><span class="icon">&#128221;</span>{{ topic.titre }}</h1>
        <p class="forum-meta"><span class="icon">&#128100;</span>Par {{ topic.auteur_nom }} - {{ topic.created_at|date:"d/m/Y H:i" }}</p>

        <div class="forum-thread">
            {% for p in posts %}
                {% include "forum_post.html" with post=p %}
            {% empty %}
            <p>Aucun message.</p>
            {% endfor %}
        </div>

        <hr>

        <div class="topic-reply" id="topic-reply">
            <h2 id="reply-heading"><span class="icon">&#9993;</span>R&eacute;pondre au sujet</h2>
            <div class="reply-context" id="reply-context" hidden>
                <span>R&eacute;ponse &agrave; <strong id="reply-context-name"></strong></span>
                <button type="button" class="link-button" id="reply-context-clear">Annuler</button>
            </div>
            <div id="reply-home"></div>
            <div id="reply-form-wrapper">
                <form method="post" class="form-style" id="reply-form">
                    {% csrf_token %}
                    {{ reply_form.as_p }}
                    <input type="hidden" name="parent_id" id="reply-parent-id">
                    <input type="text" name="hp_field" class="hp-field" autocomplete="off" tabindex="-1" aria-hidden="true">
                    <button type="submit" class="btn btn-primary">Envoyer</button>
                    <button type="button" class="btn btn-secondary" id="reply-move-back">Annuler</button>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
  (function() {
    const replyParentId = document.getElementById('reply-parent-id');
    const replyContext = document.getElementById('reply-context');
    const replyContextName = document.getElementById('reply-context-name');
    const replyContextClear = document.getElementById('reply-context-clear');
    const replyMoveBack = document.getElementById('reply-move-back');
    const replyFormWrapper = document.getElementById('reply-form-wrapper');
    const replyHome = document.getElementById('reply-home');

    function resetReplyContext() {
      replyParentId.value = '';
      replyContext.hidden = true;
      replyContextName.textContent = '';
    }

    function moveFormHome() {
      replyHome.appendChild(replyFormWrapper);
      resetReplyContext();
    }

    document.addEventListener('click', function(e) {
      const target = e.target.nodeType === 1 ? e.target : e.target.parentElement;
      if (!target) return;

      const replyButton = target.closest('[data-reply-post]');
      if (replyButton) {
        const postId = replyButton.getAttribute('data-reply-post');
        const author = replyButton.getAttribute('data-reply-author') || '';
        const card = replyButton.closest('.forum-card');
        let slot = card ? card.querySelector('.reply-slot') : null;
        if (!slot && card) {
          slot = document.createElement('div');
          slot.className = 'reply-slot';
          card.appendChild(slot);
        }
        replyParentId.value = postId;
        replyContext.hidden = false;
        replyContextName.textContent = '@' + author;
        if (slot) {
          slot.appendChild(replyFormWrapper);
          slot.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          replyHome.appendChild(replyFormWrapper);
          replyFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }
    });

    replyContextClear.addEventListener('click', function() {
      moveFormHome();
    });

    replyMoveBack.addEventListener('click', function() {
      moveFormHome();
    });

    replyHome.appendChild(replyFormWrapper);
  })();
</script>
{% endblock %}
